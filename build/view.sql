SELECT
    d.*,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = '3883508ee2b24c7e32ffab7a0495669094e8bda7' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_1`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = '0b9d4472baec48899d2ac6862777d37401ff116b' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_2`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = '65d68fc7fd9580ec398278279af739e81f46c69b' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = '63dcdaadd906301fb8d49583f076e60d6778e02b' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = 'd81269cef9a27d5fe421990a5b25d1035e726278' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = '447ae5b6e73c3aacc87873c7a2b0c6db302b6772' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = 'f9cb09a3d65029b77889df2ec437a6ea2926d903' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = '87e85a5534b18cff61f906e173354c8b1069d4df' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = '4eecb53ceb49f5b42d8f0916750909e3b11dc617' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = '302b8516b5021dab05bb0440db68fe12f6ebbbf7' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = '38e2819059967b6a5674a81fccd3119a071220ce' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = '2b79fd3ef8aeded77fddfada47808d486d7af456' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = '22465465f349d9902050838bed48cc481b8aad33' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = '465f1d50c1544de7bdf7ad752d1f96353f15cfd1' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = '59d0afccc1f28f8f07d633822ae106ee01fb88c8' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = '22491a17f6579d7759e03fdf6211dbc26c56f280' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = 'e03e32567fde47b2b76f4b45ebff2cf6accdc270' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = 'da6dbbee66a5ddf5eb03537a1120884f1e4624bc' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = 'b2d9d57ff766881c26ef19043e1acfb7b90f1acd' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = '566658a615fb64eefa4e30b05dc88b474d0437b7' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN r.KEY_PIPEDRIVE = '477c1ee94c57bfef11e8b1e749f4f1b1a288e3df' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`

FROM SB_PD_OKACADEMY.DEALS d

         JOIN SB_PD_OKACADEMY.REF_DEAL_FIELDS r
              ON r.KEY_PIPEDRIVE IS NOT NULL

         LEFT JOIN SB_PD_OKACADEMY.DEAL_CUSTOM_FIELDS dc
                   ON dc.PIPEDRIVE_KEY = r.KEY_PIPEDRIVE
                       AND dc.MAIN_ENTITY_PIPEDRIVE_ID = d.ID_PIPEDRIVE
                       AND (
                          dc.SOURCE_REQUEST_ID = d.SOURCE_REQUEST_ID OR
                          (dc.SOURCE_REQUEST_ID IS NULL AND d.SOURCE_REQUEST_ID IS NULL)
                          )

WHERE d.ID_PIPEDRIVE = 51955

GROUP BY d.ID;



SELECT
    d.*,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = '3883508ee2b24c7e32ffab7a0495669094e8bda7' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_1`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = '0b9d4472baec48899d2ac6862777d37401ff116b' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_2`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = '65d68fc7fd9580ec398278279af739e81f46c69b' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = '63dcdaadd906301fb8d49583f076e60d6778e02b' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = 'd81269cef9a27d5fe421990a5b25d1035e726278' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = '447ae5b6e73c3aacc87873c7a2b0c6db302b6772' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = 'f9cb09a3d65029b77889df2ec437a6ea2926d903' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = '87e85a5534b18cff61f906e173354c8b1069d4df' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = '4eecb53ceb49f5b42d8f0916750909e3b11dc617' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = '302b8516b5021dab05bb0440db68fe12f6ebbbf7' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = '38e2819059967b6a5674a81fccd3119a071220ce' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = '2b79fd3ef8aeded77fddfada47808d486d7af456' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = '22465465f349d9902050838bed48cc481b8aad33' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = '465f1d50c1544de7bdf7ad752d1f96353f15cfd1' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = '59d0afccc1f28f8f07d633822ae106ee01fb88c8' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = '22491a17f6579d7759e03fdf6211dbc26c56f280' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = 'e03e32567fde47b2b76f4b45ebff2cf6accdc270' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = 'da6dbbee66a5ddf5eb03537a1120884f1e4624bc' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = 'b2d9d57ff766881c26ef19043e1acfb7b90f1acd' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = '566658a615fb64eefa4e30b05dc88b474d0437b7' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`,
    MAX(CASE WHEN dc.PIPEDRIVE_KEY = '477c1ee94c57bfef11e8b1e749f4f1b1a288e3df' THEN dc.STRING_VALUE ELSE NULL END) AS `Custom_Field_3`

FROM SB_PD_OKACADEMY.DEALS d

         #          JOIN SB_PD_OKACADEMY.REF_DEAL_FIELDS r
#               ON r.KEY_PIPEDRIVE IS NOT NULL

         LEFT JOIN SB_PD_OKACADEMY.DEAL_CUSTOM_FIELDS dc

                   ON dc.MAIN_ENTITY_PIPEDRIVE_ID = d.ID_PIPEDRIVE
                       AND (
                          dc.SOURCE_REQUEST_ID = d.SOURCE_REQUEST_ID OR
                          (dc.SOURCE_REQUEST_ID IS NULL AND d.SOURCE_REQUEST_ID IS NULL)
                          )

# WHERE d.ID_PIPEDRIVE = 51951

GROUP BY d.ID;





